{"options":[{"enabled":true,"definition":{"id":"5d58cc01-7c75-450c-be18-a388ddb129ec"},"inputs":{"branchFilters":"[\"+refs/heads/*\"]","additionalFields":"{}"}},{"enabled":false,"definition":{"id":"a9db38f9-9fdc-478c-b0f9-464221e58316"},"inputs":{"workItemType":"Bug","assignToRequestor":"true","additionalFields":"{}"}}],"triggers":[{"branchFilters":["+master"],"forks":{"enabled":true,"allowSecrets":false},"pathFilters":["+/docker"],"requireCommentsForNonTeamMembersOnly":true,"isCommentRequiredForPullRequest":true,"triggerType":64},{"branchFilters":["+master"],"pathFilters":["+/docker"],"batchChanges":false,"maxConcurrentBuildsPerBranch":1,"pollingInterval":0,"triggerType":2}],"variables":{"system.debug":{"value":"false","allowOverride":true}},"variableGroups":[{"variables":{"acr-name":{"value":null,"isSecret":true},"databricks-prod-token":{"value":null,"isSecret":true},"databricks-token":{"value":null,"isSecret":true},"kcmunnin-adls-clientsecret":{"value":null,"isSecret":true}},"type":"AzureKeyVault","name":"Dev Environment","id":1}],"retentionRules":[{"branches":["+refs/heads/*"],"artifacts":[],"artifactTypesToDelete":["FilePath","SymbolStore"],"daysToKeep":10,"minimumToKeep":1,"deleteBuildRecord":true,"deleteTestResults":true}],"properties":{},"tags":[],"_links":{"self":{"href":"https://dev.azure.com/glrcsu/b02cb8ef-cd70-463d-a505-17989df23d4c/_apis/build/Definitions/17?revision=29"},"web":{"href":"https://dev.azure.com/glrcsu/b02cb8ef-cd70-463d-a505-17989df23d4c/_build/definition?definitionId=17"},"editor":{"href":"https://dev.azure.com/glrcsu/b02cb8ef-cd70-463d-a505-17989df23d4c/_build/designer?id=17&_a=edit-build-definition"},"badge":{"href":"https://dev.azure.com/glrcsu/b02cb8ef-cd70-463d-a505-17989df23d4c/_apis/build/status/17"}},"buildNumberFormat":"$(date:yyyyMMdd)$(rev:.r)","jobAuthorizationScope":1,"jobTimeoutInMinutes":60,"jobCancelTimeoutInMinutes":5,"process":{"phases":[{"steps":[{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Bash - Get Repo Name from URL without Prefix","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Microsoft, 2019\n# Sample Code.  Not for production use.\n\n# Get Name of Repo From GitHub\nREPONAME=${BUILD_REPOSITORY_URI##*/}\n\n# Store Repo Name in Task Variable\necho \"##vso[task.setvariable variable=REPONAME;]$REPONAME\"\n\n# Echo to verify\necho -e \"Repository Name: $REPONAME\"\n\n# Reference the variable in subsequent tasks with $(REPONAME)\n\nprintenv","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Populate Build ID in YAML file.","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"sed \\\n-e 's@#{BUILDID}#@$(Build.BuildId)@' \\\n-e 's@#{service-name}#@$(REPONAME)@' \\\n-e 's@#{acr-name}#@$(acr-name)@' \\\n$(Build.Repository.LocalPath)/docker/kubernetes-deployment.yaml>temp.yaml\n\ncat temp.yaml","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Bash - Copy Model File to Docker Dir","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Copy file from /model to docker app dir\ncp -a ./models/. ./docker/app/\nls -R ./docker","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Docker - Build Model Container Image","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"e28912f1-0114-4464-802a-a3a35437fd16","versionSpec":"1.*","definitionType":"task"},"inputs":{"containerregistrytype":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpoint":"0467a79f-3888-46e9-af9b-ad2512114f60","azureContainerRegistry":"amlv2servicekm4930362432.azurecr.io","command":"Build an image","dockerFile":"docker/Dockerfile","arguments":"","pushMultipleImages":"false","tagMultipleImages":"false","imageName":"$(REPONAME):$(Build.BuildId)","imageNamesPath":"","qualifyImageName":"true","qualifySourceImageName":"false","includeSourceTags":"true","includeLatestTag":"true","addDefaultLabels":"true","useDefaultContext":"true","buildContext":"","imageDigestFile":"","containerName":"","ports":"","volumes":"","envVars":"","workingDirectory":"","entrypointOverride":"","containerCommand":"","runInBackground":"true","restartPolicy":"no","maxRestartRetries":"","dockerHostEndpoint":"","enforceDockerNamingConvention":"true","memoryLimit":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Unit Test - 1 (Run Model Container)","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"e28912f1-0114-4464-802a-a3a35437fd16","versionSpec":"1.*","definitionType":"task"},"inputs":{"containerregistrytype":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpoint":"0467a79f-3888-46e9-af9b-ad2512114f60","azureContainerRegistry":"amlv2servicekm4930362432.azurecr.io","command":"Run an image","dockerFile":"**/Dockerfile","arguments":"","pushMultipleImages":"false","tagMultipleImages":"false","imageName":"$(REPONAME):$(Build.BuildId)","imageNamesPath":"","qualifyImageName":"true","qualifySourceImageName":"false","includeSourceTags":"false","includeLatestTag":"false","addDefaultLabels":"true","useDefaultContext":"true","buildContext":"**","imageDigestFile":"","containerName":"$(REPONAME)","ports":"8000:8000","volumes":"","envVars":"","workingDirectory":"","entrypointOverride":"","containerCommand":"","runInBackground":"true","restartPolicy":"no","maxRestartRetries":"","dockerHostEndpoint":"","enforceDockerNamingConvention":"true","memoryLimit":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Unit Test - 2 (Run Test in Container, Obtain Results)","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","versionSpec":"3.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Wait for previous step\nsleep 5\n\n# Run Testthat tests\ndocker exec $(REPONAME) sh -c \"ls -ls app\"\n\necho \"Running Tests\"\ndocker exec $(REPONAME) sh -c \"Rscript /app/tests/0_run.r\"\n\necho \"Copy Output to Build Agent\"\n# Copy output to build agent\n\ncd $(Build.Repository.LocalPath)\ndocker exec $(REPONAME) sh -c \"cat /app/test-result/junit_result.xml\" > junit_result.xml\n\necho \"Print Directory Information\"\n# Print Working Directory\npwd\nls -las\n\n# Print File\ncat $(Build.Repository.LocalPath)/junit_result.xml\n\n# Stop Container\ndocker rm -f $(REPONAME)","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Unit Test 3 - Publish R JUnit Test Results","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"0b0f01ed-7dde-43ff-9cbb-e48954daf9b1","versionSpec":"2.*","definitionType":"task"},"inputs":{"testRunner":"JUnit","testResultsFiles":"$(Build.Repository.LocalPath)/junit_result.xml","searchFolder":"","mergeTestResults":"false","failTaskOnFailedTests":"true","testRunTitle":"Test R Model","platform":"","configuration":"","publishRunAttachments":"true"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Docker - Push Image to ACR (BuildTag)","timeoutInMinutes":0,"condition":"and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))","task":{"id":"e28912f1-0114-4464-802a-a3a35437fd16","versionSpec":"1.*","definitionType":"task"},"inputs":{"containerregistrytype":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpoint":"0467a79f-3888-46e9-af9b-ad2512114f60","azureContainerRegistry":"amlv2servicekm4930362432.azurecr.io","command":"Push an image","dockerFile":"Dockerfile","arguments":"","pushMultipleImages":"false","tagMultipleImages":"false","imageName":"$(REPONAME):$(Build.BuildId)","imageNamesPath":"","qualifyImageName":"true","qualifySourceImageName":"false","includeSourceTags":"true","includeLatestTag":"true","addDefaultLabels":"true","useDefaultContext":"true","buildContext":"","imageDigestFile":"","containerName":"","ports":"","volumes":"","envVars":"","workingDirectory":"","entrypointOverride":"","containerCommand":"","runInBackground":"true","restartPolicy":"no","maxRestartRetries":"","dockerHostEndpoint":"","enforceDockerNamingConvention":"true","memoryLimit":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Docker - Push Image to ACR (LatestTag)","timeoutInMinutes":0,"condition":"and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))","task":{"id":"e28912f1-0114-4464-802a-a3a35437fd16","versionSpec":"1.*","definitionType":"task"},"inputs":{"containerregistrytype":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpoint":"0467a79f-3888-46e9-af9b-ad2512114f60","azureContainerRegistry":"amlv2servicekm4930362432.azurecr.io","command":"Push an image","dockerFile":"Dockerfile","arguments":"","pushMultipleImages":"false","tagMultipleImages":"false","imageName":"$(REPONAME):latest","imageNamesPath":"","qualifyImageName":"true","qualifySourceImageName":"false","includeSourceTags":"true","includeLatestTag":"true","addDefaultLabels":"true","useDefaultContext":"true","buildContext":"","imageDigestFile":"","containerName":"","ports":"","volumes":"","envVars":"","workingDirectory":"","entrypointOverride":"","containerCommand":"","runInBackground":"true","restartPolicy":"no","maxRestartRetries":"","dockerHostEndpoint":"","enforceDockerNamingConvention":"true","memoryLimit":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Publish Artifact: token","timeoutInMinutes":0,"condition":"and(succeeded(), eq(variables['Build.SourceBranchName'], 'master'))","task":{"id":"2ff763a7-ce83-4e1f-bc89-0ae63477cebe","versionSpec":"1.*","definitionType":"task"},"inputs":{"PathtoPublish":"temp.yaml","ArtifactName":"token","ArtifactType":"Container","TargetPath":"","Parallel":"false","ParallelCount":"8","FileCopyOptions":""}}],"name":"Build R Model Container","refName":"Phase_1","condition":"succeeded()","target":{"executionOptions":{"type":0},"allowScriptsAuthAccessOption":false,"type":1},"jobAuthorizationScope":1,"jobCancelTimeoutInMinutes":1}],"type":1},"repository":{"properties":{"apiUrl":"https://api.github.com/repos/kcm117/azure-rmodel-devops","branchesUrl":"https://api.github.com/repos/kcm117/azure-rmodel-devops/branches","cloneUrl":"https://github.com/kcm117/azure-rmodel-devops.git","connectedServiceId":"25d6e0f6-30ba-418e-828f-58037b28376c","defaultBranch":"master","fullName":"kcm117/azure-rmodel-devops","hasAdminPermissions":"False","isFork":"False","isPrivate":"False","lastUpdated":"09/26/2019 15:49:17","manageUrl":"https://github.com/kcm117/azure-rmodel-devops","nodeId":"MDEwOlJlcG9zaXRvcnkxNzY4Mzk5NjA=","ownerId":"11845433","orgName":"kcm117","refsUrl":"https://api.github.com/repos/kcm117/azure-rmodel-devops/git/refs","safeRepository":"kcm117/azure-rmodel-devops","shortName":"azure-rmodel-devops","ownerAvatarUrl":"https://avatars2.githubusercontent.com/u/11845433?v=4","archived":"False","externalId":"176839960","ownerIsAUser":"True","checkoutNestedSubmodules":"false","cleanOptions":"0","fetchDepth":"0","gitLfsSupport":"false","reportBuildStatus":"true","skipSyncSource":"false","labelSourcesFormat":"$(build.buildNumber)","labelSources":"0"},"id":"kcm117/azure-rmodel-devops","type":"GitHub","name":"kcm117/azure-rmodel-devops","url":"https://github.com/kcm117/azure-rmodel-devops.git","defaultBranch":"master","clean":"true","checkoutSubmodules":false},"processParameters":{},"quality":1,"authoredBy":{"displayName":"KC Munnings","url":"https://spsprodcus2.vssps.visualstudio.com/A4b9f2c77-595f-450c-b159-33f537c42fe4/_apis/Identities/4e8b8cf2-c549-4b01-a87b-319763c52ab3","_links":{"avatar":{"href":"https://dev.azure.com/glrcsu/_apis/GraphProfile/MemberAvatars/aad.ZjdlNDU5Y2QtMzc1MS03YjUyLTljY2MtNmY0NWY0ODE2MTdi"}},"id":"4e8b8cf2-c549-4b01-a87b-319763c52ab3","uniqueName":"kcmunnin@microsoft.com","imageUrl":"https://dev.azure.com/glrcsu/_apis/GraphProfile/MemberAvatars/aad.ZjdlNDU5Y2QtMzc1MS03YjUyLTljY2MtNmY0NWY0ODE2MTdi","descriptor":"aad.ZjdlNDU5Y2QtMzc1MS03YjUyLTljY2MtNmY0NWY0ODE2MTdi"},"drafts":[],"queue":{"_links":{"self":{"href":"https://dev.azure.com/glrcsu/_apis/build/Queues/46"}},"id":46,"name":"Hosted Ubuntu 1604","url":"https://dev.azure.com/glrcsu/_apis/build/Queues/46","pool":{"id":6,"name":"Hosted Ubuntu 1604","isHosted":true}},"id":17,"name":"ci-rmodel-container","url":"https://dev.azure.com/glrcsu/b02cb8ef-cd70-463d-a505-17989df23d4c/_apis/build/Definitions/17?revision=29","uri":"vstfs:///Build/Definition/17","path":"\\r-models","type":2,"queueStatus":0,"revision":29,"createdDate":"2019-09-27T01:35:06.033Z","project":{"id":"b02cb8ef-cd70-463d-a505-17989df23d4c","name":"ds-devops","description":"Sample devops project for data science, using R","url":"https://dev.azure.com/glrcsu/_apis/projects/b02cb8ef-cd70-463d-a505-17989df23d4c","state":1,"revision":183,"visibility":0,"lastUpdateTime":"2019-06-13T12:36:46.923Z"}}